pipeline {
    agent any
	tools { 
        maven 'Maven 3.3.9' 
        jdk 'jdk8'  
    }   

    environment {
        SETTINGS_SECRET_FILE = credentials('settings-secret-file')
    }

    stages {
	stage('Unit Tests') {
            steps{
                sh 'mvn -f maths/pom.xml clean test -s ${SETTINGS_SECRET_FILE}'
            }
        }

        stage ('Build & Upload Artifact') {
            steps {
                rtMavenRun (
                    tool: "Maven 3.3.9", 
                    pom: 'maths/pom.xml',
                    goals: 'clean install -Dmaven.test.skip=true -s ${SETTINGS_SECRET_FILE}',
                    deployerId: "MAVEN_DEPLOYER",
                    resolverId: "MAVEN_RESOLVER"
                )
            }
        }

        stage ('Publish build info') {
            steps {
                rtPublishBuildInfo (
                    serverId: talyi-artifactory
                )
            }
        }
	    
        stage ('Promotion') {
	    steps {
		rtPromote (
		    serverId: talyi-artifactory,
		    targetRepo: 'libs-release-local',
		    comment: 'Releasing this piece of software!',
		    sourceRepo: 'libs-staging-local',
		    status: 'Released',
		    includeDependencies: true,
		    failFast: true,
		    copy: true
		)
	    }
	}	    
    }
}
